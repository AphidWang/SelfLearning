# Supabase RPC å‡½æ•¸æ–‡æª”

æœ¬æ–‡æª”è¨˜éŒ„äº†å°ˆæ¡ˆä¸­æ‰€æœ‰çš„ Supabase RPC (Remote Procedure Call) å‡½æ•¸ï¼ŒåŒ…æ‹¬å…¶åŠŸèƒ½ã€åƒæ•¸å’Œä½¿ç”¨å ´æ™¯ã€‚

## ğŸ“‹ ç›®éŒ„

- [ä»»å‹™ç®¡ç†ç³»çµ±](#ä»»å‹™ç®¡ç†ç³»çµ±)
- [ç‰ˆæœ¬æ§åˆ¶èˆ‡æ¨‚è§€é–å®š](#ç‰ˆæœ¬æ§åˆ¶èˆ‡æ¨‚è§€é–å®š)
- [ä»»å‹™å‹•ä½œèˆ‡æ‰“å¡ç³»çµ±](#ä»»å‹™å‹•ä½œèˆ‡æ‰“å¡ç³»çµ±)
- [é€±æŒ‘æˆ°ç³»çµ±](#é€±æŒ‘æˆ°ç³»çµ±)
- [æ—¥è¨˜ç³»çµ±](#æ—¥è¨˜ç³»çµ±)
- [å·¥å…·å‡½æ•¸](#å·¥å…·å‡½æ•¸)

---

## ä»»å‹™ç®¡ç†ç³»çµ±

### `get_active_tasks_for_user(p_user_id uuid)`
**åŠŸèƒ½**: ç²å–ç”¨æˆ¶çš„æ‰€æœ‰æ´»èºä»»å‹™  
**ç”¨é€”**: TaskWall é é¢å¿«é€ŸæŸ¥è©¢ç”¨æˆ¶çš„é€²è¡Œä¸­ä»»å‹™  
**è¿”å›**: ä»»å‹™åˆ—è¡¨ï¼ŒåŒ…å«ä»»å‹™è©³æƒ…å’Œé€²åº¦ä¿¡æ¯  
**èª¿ç”¨ä½ç½®**: `topicStore.getActiveTasksForUser()`

### `get_topic_with_structure(p_topic_id uuid)`
**åŠŸèƒ½**: ç²å–ä¸»é¡Œçš„å®Œæ•´çµæ§‹ï¼ŒåŒ…å«ç›®æ¨™å’Œä»»å‹™  
**ç”¨é€”**: ä¸»é¡Œè©³æƒ…é é¢ä¸€æ¬¡æ€§è¼‰å…¥å®Œæ•´çš„ä¸»é¡Œçµæ§‹  
**è¿”å›**: ä¸»é¡ŒåŠå…¶ä¸‹å±¬ç›®æ¨™å’Œä»»å‹™çš„å®Œæ•´çµæ§‹  
**èª¿ç”¨ä½ç½®**: `topicStore.getTopicWithStructure()`

### `get_completed_tasks_for_date(target_date date, target_user_id uuid)`
**åŠŸèƒ½**: ç²å–æŒ‡å®šæ—¥æœŸç”¨æˆ¶å®Œæˆçš„ä»»å‹™  
**ç”¨é€”**: æ—¥è¨˜ç³»çµ±è‡ªå‹•è¼‰å…¥ç•¶å¤©å®Œæˆçš„ä»»å‹™  
**è¿”å›**: æŒ‡å®šæ—¥æœŸå®Œæˆçš„ä»»å‹™åˆ—è¡¨  
**èª¿ç”¨ä½ç½®**: `journalStore.saveJournalEntry()`

---

## ç‰ˆæœ¬æ§åˆ¶èˆ‡æ¨‚è§€é–å®š

### `safe_update_topic(p_id uuid, p_expected_version integer, ...)`
**åŠŸèƒ½**: å®‰å…¨æ›´æ–°ä¸»é¡Œï¼Œå¸¶ç‰ˆæœ¬æ§åˆ¶  
**ç”¨é€”**: é˜²æ­¢ä¸¦ç™¼ç·¨è¼¯è¡çª  
**åƒæ•¸**: 
- `p_id`: ä¸»é¡Œ ID
- `p_expected_version`: æœŸæœ›çš„ç‰ˆæœ¬è™Ÿ
- å…¶ä»–æ›´æ–°æ¬„ä½...
**è¿”å›**: æ›´æ–°çµæœï¼ŒåŒ…å«æ˜¯å¦æˆåŠŸå’Œç•¶å‰ç‰ˆæœ¬è™Ÿ  
**èª¿ç”¨ä½ç½®**: `topicStore.updateTopic()`

### `safe_update_goal(p_id uuid, p_expected_version integer, ...)`
**åŠŸèƒ½**: å®‰å…¨æ›´æ–°ç›®æ¨™ï¼Œå¸¶ç‰ˆæœ¬æ§åˆ¶  
**ç”¨é€”**: é˜²æ­¢ä¸¦ç™¼ç·¨è¼¯è¡çª  
**åƒæ•¸**: 
- `p_id`: ç›®æ¨™ ID
- `p_expected_version`: æœŸæœ›çš„ç‰ˆæœ¬è™Ÿ
- å…¶ä»–æ›´æ–°æ¬„ä½...
**è¿”å›**: æ›´æ–°çµæœï¼ŒåŒ…å«æ˜¯å¦æˆåŠŸå’Œç•¶å‰ç‰ˆæœ¬è™Ÿ  
**èª¿ç”¨ä½ç½®**: `topicStore.updateGoal()`

### `safe_update_task(p_id uuid, p_expected_version integer, ...)`
**åŠŸèƒ½**: å®‰å…¨æ›´æ–°ä»»å‹™ï¼Œå¸¶ç‰ˆæœ¬æ§åˆ¶  
**ç”¨é€”**: é˜²æ­¢ä¸¦ç™¼ç·¨è¼¯è¡çª  
**åƒæ•¸**: 
- `p_id`: ä»»å‹™ ID
- `p_expected_version`: æœŸæœ›çš„ç‰ˆæœ¬è™Ÿ
- å…¶ä»–æ›´æ–°æ¬„ä½...
**è¿”å›**: æ›´æ–°çµæœï¼ŒåŒ…å«æ˜¯å¦æˆåŠŸå’Œç•¶å‰ç‰ˆæœ¬è™Ÿ  
**èª¿ç”¨ä½ç½®**: `topicStore.updateTask()`

---

## ä»»å‹™å‹•ä½œèˆ‡æ‰“å¡ç³»çµ±

### `perform_task_action_transaction(p_task_id uuid, p_action_type text, p_action_date date, p_action_timestamp timestamp, p_user_id uuid, p_action_data jsonb)`
**åŠŸèƒ½**: åŸ·è¡Œä»»å‹™å‹•ä½œçš„å®Œæ•´äº‹å‹™è™•ç†  
**ç”¨é€”**: ç¢ºä¿ä»»å‹™å‹•ä½œè¨˜éŒ„å’Œé€²åº¦æ›´æ–°çš„åŸå­æ€§  
**åƒæ•¸**: 
- `p_task_id`: ä»»å‹™ ID
- `p_action_type`: å‹•ä½œé¡å‹ ('check_in', 'reset' ç­‰)
- `p_action_date`: å‹•ä½œæ—¥æœŸ
- `p_action_timestamp`: å‹•ä½œæ™‚é–“æˆ³
- `p_user_id`: ç”¨æˆ¶ ID
- `p_action_data`: é¡å¤–æ•¸æ“š (å¯é¸)
**è¿”å›**: åŸ·è¡Œçµæœå’Œæ›´æ–°å¾Œçš„ä»»å‹™æ•¸æ“š  
**èª¿ç”¨ä½ç½®**: `topicStore.performTaskAction()`  
**ç‰¹é»**: ğŸ”’ **Transaction ä¿è­‰æ•¸æ“šä¸€è‡´æ€§**

### `get_tasks_with_full_data(p_task_ids uuid[], p_goal_ids uuid[], p_topic_ids uuid[], p_start_date date, p_end_date date, p_include_actions boolean, p_include_records boolean)`
**åŠŸèƒ½**: ç²å–å®Œæ•´çš„ Task æ•¸æ“šï¼Œä¸€æ¬¡æ€§ JOIN æ‰€æœ‰ç›¸é—œæ•¸æ“š  
**ç”¨é€”**: çµ±ä¸€çš„ Task æ•¸æ“šç²å–ï¼Œé¿å…å¤šæ¬¡æŸ¥è©¢  
**åƒæ•¸**: 
- `p_task_ids`: æŒ‡å®šä»»å‹™ ID åˆ—è¡¨ (å¯é¸)
- `p_goal_ids`: æŒ‡å®šç›®æ¨™ ID åˆ—è¡¨ (å¯é¸)
- `p_topic_ids`: æŒ‡å®šä¸»é¡Œ ID åˆ—è¡¨ (å¯é¸)
- `p_start_date`: æ—¥æœŸç¯„åœé–‹å§‹ (å¯é¸)
- `p_end_date`: æ—¥æœŸç¯„åœçµæŸ (å¯é¸)
- `p_include_actions`: æ˜¯å¦åŒ…å« task_actions
- `p_include_records`: æ˜¯å¦åŒ…å« task_records
**è¿”å›**: Task åˆ—è¡¨ï¼ŒåŒ…å«å®Œæ•´çš„ actions å’Œ records æ•¸æ“š  
**èª¿ç”¨ä½ç½®**: `topicStore.getTasksWithFullData()`  
**ç‰¹é»**: ğŸš€ **O(1) JOIN æŸ¥è©¢ï¼Œé«˜æ€§èƒ½**

### `get_user_task_activities_for_date(p_date date)`
**åŠŸèƒ½**: ç²å–æŒ‡å®šæ—¥æœŸçš„ç”¨æˆ¶ä»»å‹™æ´»å‹•æ‘˜è¦  
**ç”¨é€”**: ç‚º DailyJournal æä¾›å®Œæ•´çš„ç•¶æ—¥æ´»å‹•æ•¸æ“š  
**åƒæ•¸**: 
- `p_date`: æŸ¥è©¢æ—¥æœŸ
**è¿”å›**: åŒ…å«å®Œæˆä»»å‹™ã€æ‰“å¡è¨˜éŒ„ã€å­¸ç¿’è¨˜éŒ„çš„å®Œæ•´æ´»å‹•åˆ—è¡¨  
**èª¿ç”¨ä½ç½®**: `topicStore.getUserTaskActivitiesForDate()`  
**ç‰¹é»**: ğŸ¯ **å°ˆç‚º DailyJournal å„ªåŒ–**

### `get_topics_progress_for_week(p_week_start date, p_week_end date)`
**åŠŸèƒ½**: ç²å–æŒ‡å®šé€±æœŸçš„ä¸»é¡Œé€²åº¦æ‘˜è¦  
**ç”¨é€”**: ç‚º retroStore æä¾›é€±å›é¡§æ•¸æ“šï¼ŒåŒ…å«æ²’æœ‰æ´»å‹•çš„ä¸»é¡Œ  
**åƒæ•¸**: 
- `p_week_start`: é€±é–‹å§‹æ—¥æœŸ
- `p_week_end`: é€±çµæŸæ—¥æœŸ
**è¿”å›**: ä¸»é¡Œåˆ—è¡¨ï¼ŒåŒ…å«é€²åº¦å¿«ç…§å’Œæ´»å‹•çµ±è¨ˆ  
**èª¿ç”¨ä½ç½®**: `topicStore.getTopicsProgressForWeek()`  
**ç‰¹é»**: ğŸ“Š **åŒ…å«æ‰€æœ‰æ´»èºä¸»é¡Œï¼Œå³ä½¿æ²’æœ‰æœ¬é€±æ´»å‹•**

### `get_active_topics_with_progress()`
**åŠŸèƒ½**: ç²å–æ‰€æœ‰æ´»èºä¸»é¡ŒåŠå…¶é€²åº¦ä¿¡æ¯  
**ç”¨é€”**: ç‚º retroStore æä¾›å®Œæ•´çš„ä¸»é¡Œåˆ—è¡¨å’Œé€²åº¦  
**è¿”å›**: æ´»èºä¸»é¡Œåˆ—è¡¨ï¼ŒåŒ…å«å®Œæˆç‡å’Œæœ€è¿‘æ´»å‹•ç‹€æ…‹  
**èª¿ç”¨ä½ç½®**: `topicStore.getActiveTopicsWithProgress()`  
**ç‰¹é»**: ğŸ”„ **åŒ…å«æœ€è¿‘æ´»å‹•æª¢æŸ¥**

### `cancel_today_check_in_transaction(p_task_id uuid, p_user_id uuid, p_today date)`
**åŠŸèƒ½**: å–æ¶ˆä»Šæ—¥æ‰“å¡çš„å®Œæ•´äº‹å‹™è™•ç†  
**ç”¨é€”**: ç¢ºä¿å–æ¶ˆæ‰“å¡è¨˜éŒ„å’Œé€²åº¦æ›´æ–°çš„åŸå­æ€§  
**åƒæ•¸**: 
- `p_task_id`: ä»»å‹™ ID
- `p_user_id`: ç”¨æˆ¶ ID
- `p_today`: ä»Šå¤©çš„æ—¥æœŸ
**è¿”å›**: åŸ·è¡Œçµæœå’Œæ›´æ–°å¾Œçš„ä»»å‹™æ•¸æ“š  
**èª¿ç”¨ä½ç½®**: `topicStore.cancelTodayCheckIn()`  
**ç‰¹é»**: ğŸ”’ **Transaction ä¿è­‰æ•¸æ“šä¸€è‡´æ€§**

### `task_check_in(task_uuid uuid, user_uuid uuid, note_text text)`
**åŠŸèƒ½**: ä»»å‹™æ‰“å¡ (èˆŠç‰ˆæœ¬)  
**ç‹€æ…‹**: âš ï¸ **å·²æ£„ç”¨**ï¼Œè«‹ä½¿ç”¨ `perform_task_action_transaction`  
**ç”¨é€”**: è¨˜éŒ„ä»»å‹™æ‰“å¡

### `cancel_task_check_in(task_uuid uuid, user_uuid uuid)`
**åŠŸèƒ½**: å–æ¶ˆä»»å‹™æ‰“å¡ (èˆŠç‰ˆæœ¬)  
**ç‹€æ…‹**: âš ï¸ **å·²æ£„ç”¨**ï¼Œè«‹ä½¿ç”¨ `cancel_today_check_in_transaction`  
**ç”¨é€”**: å–æ¶ˆä»»å‹™æ‰“å¡è¨˜éŒ„

### `get_task_check_in_history(task_uuid uuid, user_uuid uuid)`
**åŠŸèƒ½**: ç²å–ä»»å‹™æ‰“å¡æ­·å²è¨˜éŒ„  
**ç”¨é€”**: é¡¯ç¤ºä»»å‹™çš„æ‰“å¡æ­·å²  
**è¿”å›**: æ‰“å¡è¨˜éŒ„åˆ—è¡¨  
**èª¿ç”¨ä½ç½®**: TaskCard èƒŒé¢é¡¯ç¤ºæ‰“å¡æ­·å²

---

## é€±æŒ‘æˆ°ç³»çµ±

### `get_current_weekly_challenge(user_uuid uuid)`
**åŠŸèƒ½**: ç²å–ç”¨æˆ¶ç•¶å‰çš„é€±æŒ‘æˆ°  
**ç”¨é€”**: è¼‰å…¥ç”¨æˆ¶çš„é€±æŒ‘æˆ°ä»»å‹™  
**è¿”å›**: ç•¶å‰é€±æŒ‘æˆ°ä¿¡æ¯

### `weekly_challenge_check_in(challenge_uuid uuid, user_uuid uuid, note_text text)`
**åŠŸèƒ½**: é€±æŒ‘æˆ°æ‰“å¡  
**ç”¨é€”**: è¨˜éŒ„é€±æŒ‘æˆ°çš„æ‰“å¡å‹•ä½œ  
**åƒæ•¸**: 
- `challenge_uuid`: é€±æŒ‘æˆ° ID
- `user_uuid`: ç”¨æˆ¶ ID
- `note_text`: æ‰“å¡å‚™è¨»

### `cancel_weekly_challenge_check_in(challenge_uuid uuid, user_uuid uuid)`
**åŠŸèƒ½**: å–æ¶ˆé€±æŒ‘æˆ°æ‰“å¡  
**ç”¨é€”**: å–æ¶ˆä»Šæ—¥çš„é€±æŒ‘æˆ°æ‰“å¡è¨˜éŒ„

### `get_today_check_in_status(challenge_uuid uuid, user_uuid uuid)`
**åŠŸèƒ½**: ç²å–ä»Šæ—¥é€±æŒ‘æˆ°æ‰“å¡ç‹€æ…‹  
**ç”¨é€”**: æª¢æŸ¥ç”¨æˆ¶ä»Šå¤©æ˜¯å¦å·²ç¶“å®Œæˆé€±æŒ‘æˆ°æ‰“å¡  
**è¿”å›**: æ‰“å¡ç‹€æ…‹ä¿¡æ¯

### `get_weekly_challenge_stats(challenge_uuid uuid)`
**åŠŸèƒ½**: ç²å–é€±æŒ‘æˆ°çµ±è¨ˆä¿¡æ¯  
**ç”¨é€”**: é¡¯ç¤ºé€±æŒ‘æˆ°çš„å®Œæˆæƒ…æ³çµ±è¨ˆ  
**è¿”å›**: é€±æŒ‘æˆ°çµ±è¨ˆæ•¸æ“š

### `check_daily_check_in(challenge_uuid uuid, user_uuid uuid)`
**åŠŸèƒ½**: æª¢æŸ¥æ¯æ—¥æ‰“å¡ç‹€æ…‹  
**ç”¨é€”**: é©—è­‰ç”¨æˆ¶çš„æ¯æ—¥æ‰“å¡è¨˜éŒ„

---

## æ—¥è¨˜ç³»çµ±

### `get_completed_tasks_for_date(target_date date, target_user_id uuid)`
**åŠŸèƒ½**: ç²å–æŒ‡å®šæ—¥æœŸå®Œæˆçš„ä»»å‹™  
**ç”¨é€”**: æ—¥è¨˜ç³»çµ±è‡ªå‹•è¼‰å…¥ç•¶å¤©å®Œæˆçš„ä»»å‹™  
**è¿”å›**: ä»»å‹™åˆ—è¡¨  
**èª¿ç”¨ä½ç½®**: `journalStore.saveJournalEntry()`

---

## å·¥å…·å‡½æ•¸

### `update_updated_at_column()`
**åŠŸèƒ½**: æ›´æ–° updated_at æ¬„ä½çš„è§¸ç™¼å™¨å‡½æ•¸  
**ç”¨é€”**: è‡ªå‹•æ›´æ–°è¨˜éŒ„çš„ä¿®æ”¹æ™‚é–“  
**é¡å‹**: è§¸ç™¼å™¨å‡½æ•¸

### `update_version_and_timestamp()`
**åŠŸèƒ½**: æ›´æ–°ç‰ˆæœ¬è™Ÿå’Œæ™‚é–“æˆ³çš„è§¸ç™¼å™¨å‡½æ•¸  
**ç”¨é€”**: è‡ªå‹•éå¢ç‰ˆæœ¬è™Ÿä¸¦æ›´æ–°æ™‚é–“æˆ³  
**é¡å‹**: è§¸ç™¼å™¨å‡½æ•¸

### `update_daily_journals_updated_at()`
**åŠŸèƒ½**: æ›´æ–°æ—¥è¨˜çš„ä¿®æ”¹æ™‚é–“  
**ç”¨é€”**: æ—¥è¨˜è¡¨çš„æ™‚é–“æˆ³ç¶­è­·  
**é¡å‹**: è§¸ç™¼å™¨å‡½æ•¸

### `update_task_actions_updated_at()`
**åŠŸèƒ½**: æ›´æ–°ä»»å‹™å‹•ä½œçš„ä¿®æ”¹æ™‚é–“  
**ç”¨é€”**: ä»»å‹™å‹•ä½œè¡¨çš„æ™‚é–“æˆ³ç¶­è­·  
**é¡å‹**: è§¸ç™¼å™¨å‡½æ•¸

---

## ğŸ”§ é–‹ç™¼æŒ‡å—

### æ–°å¢ RPC å‡½æ•¸æ™‚çš„æ³¨æ„äº‹é …

1. **å‘½åè¦ç¯„**: ä½¿ç”¨æè¿°æ€§çš„åç¨±ï¼Œéµå¾ª `å‹•è©_åè©_è£œå……` çš„æ ¼å¼
2. **åƒæ•¸å‘½å**: ä½¿ç”¨ `p_` å‰ç¶´è¡¨ç¤ºåƒæ•¸
3. **éŒ¯èª¤è™•ç†**: å§‹çµ‚åŒ…å«é©ç•¶çš„éŒ¯èª¤è™•ç†é‚è¼¯
4. **æ–‡æª”æ›´æ–°**: æ–°å¢å‡½æ•¸å¾Œå‹™å¿…æ›´æ–°æ­¤æ–‡æª”
5. **æ¸¬è©¦**: ç‚ºæ–°å¢çš„ RPC å‡½æ•¸ç·¨å¯«å°æ‡‰çš„æ¸¬è©¦ç”¨ä¾‹

### Transaction å‡½æ•¸çš„ç‰¹é»

- âœ… ä¿è­‰æ•¸æ“šä¸€è‡´æ€§
- âœ… æ”¯æ´éŒ¯èª¤å›æ»¾
- âœ… é©ç”¨æ–¼è¤‡é›œçš„å¤šè¡¨æ“ä½œ
- âš ï¸ éœ€è¦ä»”ç´°è™•ç†éŒ¯èª¤æƒ…æ³

### å·²æ£„ç”¨çš„å‡½æ•¸

ä»¥ä¸‹å‡½æ•¸å·²è¢«æ–°çš„ transaction ç‰ˆæœ¬å–ä»£ï¼š
- `task_check_in` â†’ `perform_task_action_transaction`
- `cancel_task_check_in` â†’ `cancel_today_check_in_transaction`

---

## ğŸ“Š å‡½æ•¸çµ±è¨ˆ

- **ç¸½å‡½æ•¸æ•¸é‡**: 20 å€‹
- **ä»»å‹™ç®¡ç†**: 3 å€‹
- **ç‰ˆæœ¬æ§åˆ¶**: 3 å€‹
- **ä»»å‹™å‹•ä½œ**: 6 å€‹ (åŒ…å« 2 å€‹æ–°çš„ transaction å‡½æ•¸)
- **é€±æŒ‘æˆ°**: 6 å€‹
- **æ—¥è¨˜ç³»çµ±**: 1 å€‹
- **å·¥å…·å‡½æ•¸**: 4 å€‹

---

## ğŸ”„ æœ€è¿‘æ›´æ–°

- **2024-01-08**: æ–°å¢ `perform_task_action_transaction` å’Œ `cancel_today_check_in_transaction` å‡½æ•¸
- **2024-01-08**: æ¨™è¨˜èˆŠç‰ˆæœ¬çš„æ‰“å¡å‡½æ•¸ç‚ºå·²æ£„ç”¨
- **2024-01-08**: å»ºç«‹æ­¤æ–‡æª” 