# ç”¨æˆ¶ç®¡ç†æ¶æ§‹è¨­è¨ˆ

## ğŸ—ï¸ æ¶æ§‹åŸå‰‡

æˆ‘å€‘çš„ç”¨æˆ¶ç®¡ç†ç³»çµ±éµå¾ªä»¥ä¸‹è¨­è¨ˆåŸå‰‡ï¼š

1. **æ™®é€šç”¨æˆ¶æ“ä½œ**ï¼šç›´æ¥ä½¿ç”¨ Supabase client
2. **ç®¡ç†å…¶ä»–ç”¨æˆ¶**ï¼šé€šé server API é€²è¡Œç‰¹æ®Šæ¬Šé™æª¢æŸ¥

## ğŸ“ æª”æ¡ˆçµæ§‹èˆ‡è·è²¬

### å‰ç«¯ (Client)

#### `apps/client/src/services/supabase.ts`
- **ç”¨é€”**ï¼šæ™®é€šç”¨æˆ¶æ“ä½œ
- **åŠŸèƒ½**ï¼š
  - ç²å–ç•¶å‰ç”¨æˆ¶è³‡æ–™
  - æ›´æ–°è‡ªå·±çš„å€‹äººè³‡æ–™
  - èªè­‰ç›¸é—œæ“ä½œ (ç™»å…¥ã€ç™»å‡ºã€è¨»å†Š)
- **ç‰¹é»**ï¼šç›´æ¥èˆ‡ Supabase é€šä¿¡ï¼Œä¸ç¶“é server å±¤

#### `apps/client/src/store/userStore.ts` 
- **ç”¨é€”**ï¼šæ··åˆæ¨¡å¼ Store
- **åŠŸèƒ½åˆ†é¡**ï¼š
  - **æ™®é€šæ“ä½œ**ï¼š`getCurrentUser()`, `updateCurrentUser()` - ä½¿ç”¨ Supabase
  - **ç®¡ç†å“¡æ“ä½œ**ï¼š`getUsers()`, `createAuthUser()`, `updateUser()`, `deleteUser()` - ä½¿ç”¨ server API
- **è¨­è¨ˆç†ç”±**ï¼š
  - æ™®é€šæ“ä½œæ›´é«˜æ•ˆï¼Œç›´æ¥é€šä¿¡
  - ç®¡ç†æ“ä½œéœ€è¦æ¬Šé™æª¢æŸ¥ï¼Œé€šé server ç¢ºä¿å®‰å…¨

### å¾Œç«¯ (Server)

#### `apps/server/src/routes/users.ts`
- **ç”¨é€”**ï¼šåƒ…ç”¨æ–¼ç®¡ç†å“¡åŠŸèƒ½
- **åŠŸèƒ½**ï¼š
  - ç²å–æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨
  - å‰µå»ºæ–°ç”¨æˆ¶ï¼ˆåŒ…å«èªè­‰ï¼‰
  - æ›´æ–°å…¶ä»–ç”¨æˆ¶è³‡æ–™
  - åˆªé™¤ç”¨æˆ¶
  - æœå°‹å’Œç¯©é¸ç”¨æˆ¶
- **å®‰å…¨æ©Ÿåˆ¶**ï¼š
  - ä½¿ç”¨ `authenticateSupabaseToken` ä¸­é–“ä»¶
  - æ¬Šé™æª¢æŸ¥ç¢ºä¿åªæœ‰æˆæ¬Šç”¨æˆ¶å¯ä»¥åŸ·è¡Œç®¡ç†æ“ä½œ

#### `apps/server/src/services/supabase.ts`
- **ç”¨é€”**ï¼šserver ç«¯ Supabase æ“ä½œ
- **åŠŸèƒ½**ï¼šä½¿ç”¨ service role key é€²è¡Œé«˜æ¬Šé™æ“ä½œ
- **æ¬Šé™**ï¼šå¯ä»¥ç®¡ç† auth.users å’ŒåŸ·è¡Œç®¡ç†å“¡ç´šåˆ¥çš„è³‡æ–™åº«æ“ä½œ

## ğŸ”€ è³‡æ–™æµç¨‹

### æ™®é€šç”¨æˆ¶æ“ä½œæµç¨‹
```
ç”¨æˆ¶ â†’ userStore.getCurrentUser() â†’ services/supabase.ts â†’ Supabase
ç”¨æˆ¶ â†’ userStore.updateCurrentUser() â†’ services/supabase.ts â†’ Supabase
```

### ç®¡ç†å“¡æ“ä½œæµç¨‹
```
ç®¡ç†å“¡ â†’ userStore.getUsers() â†’ /api/users â†’ authenticateSupabaseToken â†’ server/services/supabase.ts â†’ Supabase
```

## ğŸ›¡ï¸ å®‰å…¨è€ƒé‡

### å‰ç«¯æ¬Šé™
- æ™®é€šç”¨æˆ¶åªèƒ½æ“ä½œè‡ªå·±çš„è³‡æ–™
- Supabase RLS (Row Level Security) æ”¿ç­–ç¢ºä¿è³‡æ–™å®‰å…¨
- åªæš´éœ²å¿…è¦çš„ Supabase æ¬Šé™

### å¾Œç«¯æ¬Šé™  
- ä½¿ç”¨ service role keyï¼Œæ“æœ‰å®Œæ•´çš„ Supabase æ¬Šé™
- æ‰€æœ‰ç®¡ç†å“¡ API éƒ½éœ€è¦ token é©—è­‰
- å¯ä»¥å¯¦æ–½æ›´ç´°ç·»çš„æ¬Šé™æ§åˆ¶

## ğŸš€ å„ªå‹¢

1. **æ•ˆèƒ½å„ªåŒ–**ï¼šæ™®é€šæ“ä½œç›´æ¥é€šä¿¡ï¼Œæ¸›å°‘ç¶²è·¯å»¶é²
2. **å®‰å…¨æ€§**ï¼šç®¡ç†æ“ä½œé€šé server é€²è¡Œæ¬Šé™æª¢æŸ¥
3. **å¯æ“´å±•æ€§**ï¼šå®¹æ˜“æ·»åŠ æ–°çš„ç®¡ç†åŠŸèƒ½å’Œæ¬Šé™æ§åˆ¶
4. **æ¸…æ™°åˆ†é›¢**ï¼šè·è²¬æ˜ç¢ºï¼Œæ˜“æ–¼ç¶­è­·å’Œç†è§£

## ğŸ“ ä½¿ç”¨ç¯„ä¾‹

### æ™®é€šç”¨æˆ¶æ“ä½œ
```typescript
// ç²å–ç•¶å‰ç”¨æˆ¶
const user = await useUserStore.getState().getCurrentUser();

// æ›´æ–°å€‹äººè³‡æ–™
await useUserStore.getState().updateCurrentUser({
  name: 'æ–°åå­—',
  avatar: 'new-avatar-url'
});
```

### ç®¡ç†å“¡æ“ä½œ
```typescript
// ç²å–æ‰€æœ‰ç”¨æˆ¶ (éœ€è¦ç®¡ç†å“¡æ¬Šé™)
await useUserStore.getState().getUsers();

// å‰µå»ºæ–°ç”¨æˆ¶ (éœ€è¦ç®¡ç†å“¡æ¬Šé™)
await useUserStore.getState().createAuthUser({
  email: 'new@example.com',
  password: 'password',
  name: 'æ–°ç”¨æˆ¶',
  role: 'student'
});
```

## âš ï¸ æ³¨æ„äº‹é …

1. **é¿å…æ··ç”¨**ï¼šä¸è¦åœ¨æ™®é€šæ“ä½œä¸­ä½¿ç”¨ server API
2. **æ¬Šé™æª¢æŸ¥**ï¼šç®¡ç†å“¡åŠŸèƒ½å¿…é ˆç¢ºä¿ç”¨æˆ¶æœ‰é©ç•¶æ¬Šé™
3. **éŒ¯èª¤è™•ç†**ï¼šå…©ç¨®æ¨¡å¼çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ä¸åŒï¼Œéœ€è¦é©ç•¶è™•ç†
4. **ä¸€è‡´æ€§**ï¼šç¢ºä¿å‰ç«¯ç›´æ¥æ“ä½œå’Œå¾Œç«¯ API çš„è³‡æ–™æ ¼å¼ä¸€è‡´

---

æœ€å¾Œæ›´æ–°ï¼š$(date)
ç¶­è­·è€…ï¼šé–‹ç™¼åœ˜éšŠ 