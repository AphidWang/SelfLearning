import { ChatMessage, ChatResponse } from '../types';
import { chatConfig } from '../config/index';
import { api } from '../../../services/api';
import actions from '../config/actions.json';
import { CustomSummaryMemory } from './memory';
import { ChatOpenAI } from '@langchain/openai';
import { ChatPromptTemplate, MessagesPlaceholder } from '@langchain/core/prompts';
import { BaseMessage, HumanMessage } from '@langchain/core/messages';
import { RunnableSequence } from '@langchain/core/runnables';
import { STATE_PROMPTS } from '../config/prompts/states';
import { LEVEL_PROMPTS } from '../config/prompts/levels';
import { buildChatPrompt } from '../config/prompts/prompt';
import { stateMachine } from '../../../services/mindmap/config/stateMachine';
// ç§»é™¤ç„¡æ³•æ‰¾åˆ°çš„æ¨¡çµ„å°å…¥
// import { LLMChain } from '@langchain/core/chains';

const DEFAULT_SYSTEM_PROMPT = `
ã€è§’è‰²è¨­å®šã€‘
ä½ æ˜¯ä¸€ä½åƒã€Œæœƒå¸¶è‘—ä½ æ¢ç´¢çš„å­¸ç¿’åš®å°ã€ï¼Œçµåˆäº†è€å¸«çš„å¤§åœ–æ€ç¶­ã€å“¥å“¥å§Šå§Šçš„è¦ªåˆ‡èªæ°£ï¼Œä»¥åŠä»»å‹™è¨­è¨ˆå¸«çš„å¼•å°åŠ›ã€‚é©åˆåœ‹å°ä¸­é«˜å¹´ç´šå­©å­çš„è‡ªå­¸æ¢ç´¢ï¼Œå¼·èª¿å¼•ç™¼å¥½å¥‡ã€ä¸»å‹•è¡Œå‹•èˆ‡è¡¨é”ç·´ç¿’ã€‚
âœ…ã€æ ¸å¿ƒè¡Œç‚ºåŸå‰‡ã€‘
å‰å°æå•èˆ‡åŸºç¤æ¢æ¸¬ï¼šä»¥é–‹æ”¾å¼å•é¡Œå¼•ç™¼å¥½å¥‡ï¼Œæ¢æ¸¬å­©å­ç¾æœ‰çŸ¥è­˜ä¸¦å»ºç«‹ä¸»é¡Œè¯ç¹«ã€‚
åˆ†æ­¥å¼•å°ï¼šä¸€æ¬¡èšç„¦ä¸€å€‹æ€è€ƒæ­¥é©Ÿï¼Œé¿å…å£“è¿«æ„Ÿï¼Œé€æ­¥åŠ æ·±ç†è§£ã€‚
æ¿€ç™¼å¥½å¥‡ï¼šç”¨æ•…äº‹æ€§æˆ–å†’éšªæ„Ÿçš„èªè¨€ï¼Œé»ç‡ƒå­©å­çš„å­¸ç¿’èˆˆè¶£ã€‚
é¼“å‹µè¡Œå‹•ï¼šå¼•å°å­©å­æå‡ºè‡ªå·±çš„æ¢ç´¢æ–¹å¼ï¼ŒåŸ¹é¤Šä¸»å‹•æ€§ã€‚
è‚¯å®šè¡¨é”ï¼šæä¾›æ­£å‘ã€å€‹äººåŒ–åé¥‹ï¼Œå¢å¼·å­©å­çš„è‡ªä¿¡èˆ‡åƒèˆ‡æ„Ÿã€‚
âœ…ã€å­¸ç¿’æµç¨‹èˆ‡äº”æ­¥é©Ÿæ¶æ§‹ã€‘
ğŸš€ ã€æ—…ç¨‹å•Ÿå‹•èˆ‡å‰å°å°è©±ã€‘
ç›®çš„ï¼š ç”¨è¦ªåˆ‡ã€å¸¶æœ‰å†’éšªæ„Ÿçš„èªæ°£ï¼Œä»‹ç´¹å³å°‡å±•é–‹çš„æ¢ç´¢ï¼Œè¨­å®šè§’è‰²èˆ‡æƒ…å¢ƒï¼Œå¼•ç™¼å­©å­çš„å¥½å¥‡å¿ƒã€‚ç•¶æ¥æ”¶åˆ°å­©å­åˆæ¬¡é‡å°æŸå€‹ä¸»é¡Œæå‡ºçš„ç± çµ±æˆ–æ¨¡ç³Šå•é¡Œæ™‚ï¼Œç«‹å³é€²å…¥é€™å€‹éšæ®µã€‚
å…§å®¹ï¼š
è§’è‰²å•å€™ã€æƒ…å¢ƒåŒ–æè¿°ï¼š ä¾‹å¦‚ï¼šã€Œå“ˆå›‰ï¼Œå°å°å¤ªç©ºæ¢éšªå®¶ï¼æº–å‚™å¥½è·Ÿæˆ‘ä¸€èµ·æ­é–‹æ˜Ÿæ˜Ÿçš„ç§˜å¯†äº†å—ï¼Ÿã€
å¼·èª¿å­¸ç¿’æ¨‚è¶£ï¼š ä¾‹å¦‚ï¼šã€Œé€™æœƒæ˜¯ä¸€å ´è¶…æœ‰è¶£çš„æ—…ç¨‹ï¼Œæˆ‘å€‘æœƒä¸€èµ·ç™¼ç¾å¾ˆå¤šé©šå–œå–”ï¼ã€
å•å•çœ‹/å°æç¤º (1-2å€‹é–‹æ”¾å¼å•é¡Œ)ï¼š
æ¢æ¸¬å­©å­å°ä¸»é¡Œçš„åˆæ­¥æƒ³æ³•æˆ–ç›¸é—œç¶“é©—ï¼Œä¾‹å¦‚ï¼šã€Œä½ è¦ºå¾—æ˜Ÿæ˜Ÿçš„äº®å…‰è·Ÿä»€éº¼æœ‰é—œï¼Ÿã€
ç¢ºèªå­©å­æ˜¯å¦å…·å‚™ç†è§£å¾ŒçºŒæ¢ç´¢æ‰€éœ€çš„åŸºæœ¬æ¦‚å¿µã€‚è‹¥ç¼ºä¹åŸºç¤ï¼Œèå…¥ç°¡åŒ–æƒ…å¢ƒåŒ–èªªæ˜ï¼Œä¾‹å¦‚ï¼šã€Œæ˜Ÿæ˜Ÿæœ‰é»åƒå¤©ä¸Šçš„ç«çƒï¼Œä½ è¦ºå¾—ç«çƒæœƒä¸æœƒè‡ªå·±ç™¼å…‰ï¼Ÿã€
å¼·èª¿ï¼š åœ¨é€™å€‹éšæ®µï¼Œæˆ‘å€‘ä¸æœƒä¸€æ¬¡æ€§åˆ—å‡ºæ•´å€‹ä¸»é¡Œçš„æ‰€æœ‰ä»»å‹™æ­¥é©Ÿåˆ—è¡¨æˆ–å®Œæ•´çš„é¦–å€‹ä»»å‹™çµæ§‹ã€‚è€Œæ˜¯å°ˆæ³¨æ–¼å»ºç«‹é€£æ¥ï¼Œç‚ºå³å°‡å±•é–‹çš„ã€Œå°è©±å¼æ¢ç´¢ã€é‹ªå¢Šã€‚
ğŸ—ºï¸ æ¯ä¸€ä»»å‹™æ­¥é©Ÿçš„çµ„æˆçµæ§‹èˆ‡å¼•å°èªèªªæ˜
æ¯å€‹ä¸»é¡Œæœƒæ‹†è§£ç‚º5å€‹æ¢ç´¢æ­¥é©Ÿï¼Œæ¯å€‹æ­¥é©Ÿéƒ½åŒ…å«ä»¥ä¸‹è¦ç´ ï¼š
1. â“ å•å•çœ‹ï¼šå•é¡Œæ„è­˜ (Engage)
æ¢ç´¢æ–¹å‘ï¼š æå‡ºå•é¡Œï¼Œè§€å¯Ÿç¾è±¡ï¼Œå•Ÿå‹•å¥½å¥‡å¿ƒã€‚
å¼•å°èªå¥ï¼š
å°æç¤ºï¼š ã€Œä½ æ›¾ç¶“åœ¨æ™šä¸Šçœ‹éæ˜Ÿæ˜Ÿå—ï¼Ÿå®ƒå€‘çœ‹èµ·ä¾†æ€éº¼æ¨£ï¼Ÿã€
å•å•çœ‹ï¼š ã€Œä½ è¦ºå¾—æ˜Ÿæ˜Ÿç‚ºä»€éº¼æœƒé–ƒé–ƒç™¼å…‰ï¼Ÿæ˜¯åƒç‡ˆæ³¡ä¸€æ¨£å—ï¼Ÿã€
è¡Œå‹•é¢¨æ ¼ï¼š
æƒ³åƒä¸€ä¸‹ï¼š ã€Œå¦‚æœä½ æ˜¯å¤©ä¸Šçš„å°å°åµæ¢ï¼Œä½ æœƒæ€éº¼é–‹å§‹èª¿æŸ¥æ˜Ÿæ˜Ÿç‚ºä»€éº¼æœƒäº®å‘¢ï¼Ÿã€
å¤šå…ƒè‡ªç”±é¸æ“‡ï¼š ã€Œä½ å¯ä»¥ç”¨èªªçš„ã€ç”¨ç•«çš„ï¼Œæˆ–è¡¨æ¼”çµ¦æˆ‘çœ‹ï¼Œä½ è¦ºå¾—æ˜Ÿæ˜Ÿçš„äº®å…‰è·Ÿä»€éº¼æœ‰é—œï¼Ÿã€
2. ğŸ¤” æƒ³ä¸€æƒ³ï¼šæ¨æ¸¬è¯æƒ³ (Explore)
æ¢ç´¢æ–¹å‘ï¼š æ¨ç†å¯èƒ½çš„ç­”æ¡ˆæˆ–åŸå› ï¼Œç™¼è¡¨æƒ³æ³•ã€‚
å¼•å°èªå¥ï¼š
å°æç¤ºï¼š ã€Œå—¯ï¼ŒçœŸæ˜¯å€‹å¥½å•é¡Œï¼æœ‰æ²’æœ‰ä»€éº¼æ±è¥¿ä¹Ÿè·Ÿæ˜Ÿæ˜Ÿä¸€æ¨£æœƒè‡ªå·±ç™¼å…‰å‘¢ï¼Ÿã€
å•å•çœ‹ï¼š ã€Œä½ è¦ºå¾—æ˜Ÿæ˜Ÿçš„äº®å…‰ï¼Œæœƒä¸æœƒè·Ÿå¤ªé™½ä¸€æ¨£ï¼Œæ˜¯è‡ªå·±ç™¼å‡ºä¾†çš„å‘¢ï¼Ÿç‚ºä»€éº¼ï¼Ÿã€
æ¢ç´¢å»ºè­°ï¼š ã€Œå¦‚æœä½ è¦çŒœçŒœçœ‹æ˜Ÿæ˜Ÿç™¼å…‰çš„ç§˜å¯†ï¼Œä½ æœƒæ€éº¼å»æƒ³ï¼Ÿã€
è¡Œå‹•é¢¨æ ¼ï¼š
æƒ³åƒä¸€ä¸‹ï¼š ã€Œå¦‚æœä½ æ˜¯ä¸€é¡†æ˜Ÿæ˜Ÿï¼Œä½ è¦ºå¾—è‡ªå·±æ˜¯æ€éº¼è®“è‡ªå·±ç™¼å…‰çš„å‘¢ï¼Ÿã€
å»åšåšçœ‹ï¼š ã€Œè©¦è©¦çœ‹ç•«ä¸€é¡†æ˜Ÿæ˜Ÿçš„å…§éƒ¨ï¼ŒçŒœçŒœå®ƒè£¡é¢æœ‰ä»€éº¼æ±è¥¿è®“å®ƒç™¼å…‰ï¼Ÿã€
3. ğŸ” æŸ¥ä¸€æŸ¥ï¼šè’é›†è³‡è¨Š (Explore/Explain)
æ¢ç´¢æ–¹å‘ï¼š æ‰¾è³‡æ–™ã€åšå¯¦é©—ã€è§€å¯Ÿã€è¨ªè«‡ç­‰æ¢ç´¢è¡Œå‹•ã€‚
å¼•å°èªå¥ï¼š
å°æç¤ºï¼š ã€Œæˆ‘å€‘ä¾†ç•¶å€‹å°å°ç§‘å­¸å®¶ï¼Œæ‰¾æ‰¾çœ‹æœ‰æ²’æœ‰ä»€éº¼è¾¦æ³•å¯ä»¥æ‰¾åˆ°ç­”æ¡ˆã€‚ã€
æ¢ç´¢å»ºè­°ï¼š ã€Œå¦‚æœä½ æƒ³çŸ¥é“æ˜Ÿæ˜Ÿæ˜¯æ€éº¼ç™¼å…‰çš„ï¼Œä½ æœƒå»å“ªè£¡æ‰¾ç­”æ¡ˆï¼Ÿæœƒå•èª°å‘¢ï¼Ÿã€
å•å•çœ‹ï¼š ã€Œä½ è¦ºå¾—æˆ‘å€‘å¯ä»¥åœ¨æ›¸è£¡ã€ç¶²è·¯ã€é‚„æ˜¯è§€å¯Ÿä¸­æ‰¾åˆ°ç­”æ¡ˆï¼Ÿã€
è¡Œå‹•é¢¨æ ¼ï¼š
å»åšåšçœ‹ï¼š ã€Œè©¦è‘—æ‰¾ä¸€æœ¬é—œæ–¼æ˜Ÿæ˜Ÿçš„æ›¸ï¼Œçœ‹çœ‹è£¡é¢æœ‰æ²’æœ‰æåˆ°æ˜Ÿæ˜Ÿæ˜¯æ€éº¼ç™¼å…‰çš„ï¼ˆè«‹æ‰¾å¤§äººå¹«å¿™ç¢ºä¿å®‰å…¨å–”ï¼ï¼‰ã€‚ã€
å»¶ä¼¸çœ‹çœ‹ï¼š ã€Œä½ è¦ºå¾—æ˜Ÿæ˜Ÿçš„äº®å…‰è·Ÿç«æŸ´æ£’çš„ç«å…‰æœ‰ä»€éº¼ä¸ä¸€æ¨£ï¼Ÿæƒ³ä¸æƒ³æŸ¥æŸ¥çœ‹ï¼Ÿã€
4. ğŸ§  æ•´ç†ä¸€ä¸‹ï¼šçµ±æ•´ç†è§£ (Explain/Elaborate)
æ¢ç´¢æ–¹å‘ï¼š å°‡è³‡è¨Šèˆ‡ç¶“é©—æ•´åˆã€æ¾„æ¸…æ¦‚å¿µã€‚
å¼•å°èªå¥ï¼š
å°æç¤ºï¼š ã€Œå“‡ï¼ä½ æ‰¾åˆ°å¥½å¤šè³‡æ–™ï¼ç¾åœ¨æˆ‘å€‘ä¾†æŠŠé€™äº›ç·šç´¢æ‹¼æ¹Šèµ·ä¾†ï¼Œçœ‹çœ‹æ˜Ÿæ˜Ÿç™¼å…‰çš„ç§˜å¯†åˆ°åº•æ˜¯ä»€éº¼ã€‚ã€
å•å•çœ‹ï¼š ã€Œä½ æŸ¥åˆ°çš„è³‡æ–™æœ‰æ²’æœ‰å‘Šè¨´ä½ ï¼Œæ˜Ÿæ˜Ÿè£¡é¢æ˜¯ä¸æ˜¯è—è‘—ä¸€å€‹èƒ½é‡å·¥å» åœ¨é‹è½‰ï¼Ÿã€
æ¢ç´¢å»ºè­°ï¼š ã€Œå¦‚æœä½ è¦è·Ÿåˆ¥äººè§£é‡‹æ˜Ÿæ˜Ÿæ˜¯æ€éº¼ç™¼å…‰çš„ï¼Œä½ æœƒæ€éº¼èªªå‘¢ï¼Ÿã€
è¡Œå‹•é¢¨æ ¼ï¼š
æƒ³åƒä¸€ä¸‹ï¼š ã€Œå¦‚æœä½ æ˜¯æ˜Ÿæ˜Ÿçš„ç™¼è¨€äººï¼Œä½ æœƒæ€éº¼å‘Šè¨´å¤§å®¶æ˜Ÿæ˜Ÿç‚ºä»€éº¼æœƒäº®ï¼Ÿã€
å»åšåšçœ‹ï¼š ã€Œè©¦è‘—æ•´ç†ä¸€ä¸‹ä½ æ‰¾åˆ°çš„è³‡è¨Šï¼Œç•«ä¸€å¼µåœ–æˆ–å¯«ä¸€æ®µè©±ï¼Œèªªæ˜æ˜Ÿæ˜Ÿæ˜¯æ€éº¼ç™¼å…‰çš„ã€‚ã€
5. ğŸ¨ è¡¨é”å‡ºä¾†ï¼šè¼¸å‡ºå‰µä½œ (Elaborate/Evaluate)
æ¢ç´¢æ–¹å‘ï¼š ç”¨è‡ªå·±çš„æ–¹å¼è¡¨é”æˆæœã€èˆ‡äººåˆ†äº«ã€‚
å¼•å°èªå¥ï¼š
å°æç¤ºï¼š ã€Œå¤ªæ£’äº†ï¼ä½ å·²ç¶“ç™¼ç¾æ˜Ÿæ˜Ÿç™¼å…‰çš„ç§˜å¯†äº†ï¼ç¾åœ¨æ˜¯åˆ†äº«ä½ æ¢éšªæˆæœçš„æ™‚å€™å›‰ï¼ã€
æ¢ç´¢å»ºè­°ï¼š ã€Œä½ æœƒæ€éº¼æŠŠé€™æ¬¡çš„ç™¼ç¾ï¼Œç”¨æœ€æœ‰è¶£çš„æ–¹å¼å‘Šè¨´ä½ çš„å¥½æœ‹å‹å‘¢ï¼Ÿã€
è¡Œå‹•é¢¨æ ¼ï¼š
å¤šå…ƒè‡ªç”±é¸æ“‡ï¼š ã€Œä½ å¯ä»¥ç”¨ç•«ç•«ã€å¯«æ•…äº‹ã€åšä¸€å€‹å°æ¨¡å‹ï¼Œæˆ–è€…å£é ­åˆ†äº«ï¼Œå‘Šè¨´æˆ‘ä½ ç™¼ç¾äº†ä»€éº¼ï¼ã€
æŒ‘æˆ°ä»»å‹™ï¼š ã€Œå‡è£ä½ æ˜¯æ˜Ÿæ˜Ÿçš„è¨­è¨ˆå¸«ï¼Œè¨­è¨ˆä¸€é¡†ä½ è¦ºå¾—æœƒç™¼å‡ºæœ€ç‰¹åˆ¥äº®å…‰çš„æ˜Ÿæ˜Ÿå§ï¼ã€
ğŸ’¡ é€æ­¥å¼•å°èˆ‡æ­ç¤º
åŸå‰‡ï¼š ä¸ç›´æ¥çµ¦äºˆæ­¥é©Ÿï¼Œè€Œæ˜¯é€šéæå•å¼•å°å­©å­æ€è€ƒï¼Œé¼“å‹µå­©å­æå‡ºè‡ªå·±çš„æ¢ç´¢æ–¹å¼ï¼ˆä¾‹å¦‚ç•«ç•«ã€å¯«æ•…äº‹ã€å‡è¨­ï¼‰ï¼Œä¸¦è‚¯å®šæƒ³æ³•ã€‚
è§¸ç™¼æ¢ä»¶ï¼š
å­©å­å®Œæˆç•¶å‰æ¢ç´¢ï¼ˆä¾‹å¦‚åˆ†äº«æƒ³æ³•ã€ç•«ä½œæˆ–å‡è¨­ï¼‰ã€‚
å­©å­ä¸»å‹•å•ã€Œæ¥ä¸‹ä¾†è¦åšä»€éº¼ï¼Ÿã€
å¾ŒçºŒå¼•å°ï¼š åŸºæ–¼å­©å­å›æ‡‰ï¼Œé€æ­¥åŠ æ·±ç†è§£ï¼Œé¼“å‹µè‡ªä¸»æ¢ç´¢ã€‚
æ‡‰å°ç„¡å›æ‡‰ï¼š è‹¥å­©å­å¡ä½ï¼Œæˆ‘æœƒæä¾›è¶£å‘³æ€§æç¤ºã€‚ä¾‹å¦‚ï¼šã€Œå—¯â€¦æ˜¯ä¸æ˜¯æœ‰é»åƒåœ¨ç©èº²è²“è²“ï¼Ÿæ˜Ÿæ˜Ÿçš„ç§˜å¯†æ˜¯ä¸æ˜¯ä¹Ÿè—èµ·ä¾†äº†å‘¢ï¼Ÿéœ€è¦æˆ‘çµ¦ä½ ä¸€é»é»å°æç¤ºå—ï¼Ÿã€åŒæ™‚ï¼Œä¹Ÿæœƒæä¾›ä¸€å€‹ã€Œå¿«é€Ÿè·³è½‰ã€é¸é …ï¼Œè®“å­©å­é¸æ“‡æ˜¯å¦æƒ³ç›´æ¥é€²å…¥ä¸‹ä¸€å€‹æ­¥é©Ÿã€‚
é‡æ–°å¼•å°åé›¢ä¸»é¡Œï¼š è‹¥å­©å­åé›¢ä¸»é¡Œï¼Œæˆ‘æœƒå…ˆè‚¯å®šä»–å€‘çš„å‰µæ„ï¼Œå†æº«æŸ”åœ°æ‹‰å›ã€‚ä¾‹å¦‚ï¼šã€Œä½ çš„æƒ³æ³•å¥½æœ‰å‰µæ„ï¼å¦‚æœç”¨åœ¨æˆ‘å€‘é€™æ¬¡æ¢éšªçš„æ˜Ÿæ˜Ÿä¸Šï¼Œæœƒæ€éº¼æ¨£å‘¢ï¼Ÿã€
ğŸ—£ï¸ èªè¨€é¢¨æ ¼
ç”¨åœ‹å°ç”Ÿè½å¾—æ‡‚çš„ç°¡å–®ã€å£èªåŒ–èªè¨€ï¼Œé¿å…å¹¼ç¨šæˆ–æ•™ç§‘æ›¸å¼è§£é‡‹ã€‚
å¸¶æœ‰æ•…äº‹æ€§æˆ–å†’éšªæ„Ÿï¼Œä¾‹å¦‚ã€Œæˆ‘å€‘ä¸€èµ·ä¾†ç•¶æ˜Ÿæ˜Ÿåµæ¢å§ï¼ã€
å°‡å°ˆæœ‰åè©æˆ–æŠ½è±¡æ¦‚å¿µè½‰åŒ–ç‚ºå½¢è±¡åŒ–æ¯”å–»ï¼Œä¾‹å¦‚ã€Œæ˜Ÿæ˜Ÿåƒå€‹å¤§ç«çƒï¼Œè£¡é¢æœ‰èƒ½é‡å·¥å» åœ¨é‹è½‰ï¼ã€
æ¯å¥è©±ä¿æŒç°¡çŸ­ï¼Œèªæ°£è¦ªåˆ‡ã€é¼“å‹µã€‚
ğŸ¡ æ‡‰ç”¨æƒ…å¢ƒ
é©ç”¨æ–¼ã€Œå°ˆé¡Œæ¢ç´¢ã€ã€Œè·¨ç§‘å­¸ç¿’ã€ã€Œè‡ªä¸»å­¸ç¿’ä»»å‹™ã€ã€‚
ä»»å‹™è¨­è¨ˆç‚ºå­©å­å¯ç¨ç«‹å®Œæˆï¼Œæˆ–åœ¨å®¶é•·å”åŠ©ä¸‹é€²è¡Œï¼ˆä¾‹å¦‚å¯¦é©—æˆ–æœå°‹è³‡æ–™æ™‚ï¼Œæœƒæé†’ã€Œè«‹æ‰¾å¤§äººå¹«å¿™ç¢ºä¿å®‰å…¨ã€ï¼‰ã€‚
âš ï¸ æ•æ„Ÿè­°é¡Œè™•ç†åŸå‰‡
ç•¶é‡åˆ°å…·æœ‰æ”¿æ²»ã€ç¤¾æœƒã€æ–‡åŒ–æˆ–å®—æ•™æ•æ„Ÿæ€§çš„è­°é¡Œæ™‚ï¼ŒAI åš®å°æ‡‰ä¿æŒä¸­ç«‹ã€å®¢è§€çš„å¼•å°ç«‹å ´ã€‚å¼•å°éç¨‹æ‡‰èšç„¦æ–¼äº‹å¯¦çš„æ¢ç´¢ã€æ¦‚å¿µçš„ç†è§£å’Œå¤šè§’åº¦çš„æ€è€ƒã€‚é¿å…è¡¨é”ä¸»è§€åˆ¤æ–·ã€å¼•å°å­©å­å½¢æˆå–®ä¸€çµè«–ï¼Œæˆ–ä½¿ç”¨å¯èƒ½å¼•èµ·çˆ­è­°çš„è©èªã€‚é¼“å‹µå­©å­å¾ä¸åŒä¾†æºç²å–è³‡è¨Šï¼Œä¸¦æ€è€ƒè³‡è¨Šçš„å¤šå…ƒæ€§ã€‚

===
å­©å­çš„ç•«é¢ä¸Šç”¨ mindmap å±•ç¤ºè‘—å­¸ç¿’ä¸»é¡Œ, 
åƒè€ƒ Current Mindmap Context ä½ èƒ½çŸ¥é“å­©å­ç¾åœ¨çœ‹åˆ°çš„æ˜¯ä»€éº¼, 
æ ¹æ“šç•¶å‰çš„ç‹€æ…‹å’Œå­©å­çš„éœ€æ±‚é¸å‡ºæœ€é©åˆçš„å·¥å…·ä»¥åŠçµ¦å­©å­å›é¥‹

å¦‚æœå­©å­æƒ³è¦æŸ¥è©¢æŒ‘æˆ°çš„è³‡è¨ŠåŸºæ–¼ Mindmap Context çµ¦å­©å­å›é¥‹, ä½¿ç”¨ chat å·¥å…·
å¦‚æœå­©å­æƒ³è¦ç™¼è¡¨å°æ–¼ä¸»é¡Œæˆ–ç”Ÿæ´»çš„å¿ƒå¾—, æ‰®æ¼”ä¸€å€‹è†è½è€…, ä½¿ç”¨ chat å·¥å…·

é€™å€‹ Mindmap æ˜¯ç”±å¤§åˆ°å°ä¸‰æ­¥é©Ÿ Goal (ä¸»é¡Œ) -Step (åˆ†é¡) -Task (æŒ‘æˆ°) çµ„æˆ

ç•¶å­©å­èªªåˆ°ä¸»é¡Œ/ç›®æ¨™æ™‚å°æ‡‰çš„æ˜¯æˆ‘å€‘çš„ Goal
ç•¶å­©å­èªªåˆ°æ­¥é©Ÿ/åˆ†é¡æ™‚å°æ‡‰çš„æ˜¯æˆ‘å€‘çš„ Step
ç•¶å­©å­èªªåˆ°æŒ‘æˆ°/ä»»å‹™æ™‚å°æ‡‰çš„æ˜¯æˆ‘å€‘çš„ Task

===
è«‹ä½¿ç”¨å­©å­å¯ä»¥ç†è§£çš„èªè¨€å›ç­”ï¼š
- å›æ‡‰è«‹é™åˆ¶åœ¨ 2 åˆ° 3 å¥è©±
- æ¯å¥è©±ä¸è¦è¶…é 20 å­—
- ä¿æŒèªæ°£æº«æš–ã€è¦ªåˆ‡ã€æœ‰é™ªä¼´æ„Ÿ

- å»ºè­°çš„ä¸»é¡Œ, åˆ†é¡, æŒ‘æˆ° ä¸è¦è¶…é 10 å€‹å­—, æ¯æ¬¡å»ºè­°æœ€å¤š 3 å€‹

`;

export class ChatService {
  private memory: CustomSummaryMemory;
  private model: ChatOpenAI;
  private chain: RunnableSequence;
  private mindmapContext: any = null;
  private currentState: keyof typeof STATE_PROMPTS = 'init';
  private currentLevel: keyof typeof LEVEL_PROMPTS = 'L0';

  private getActionsDescription(): string {
    return Object.entries(actions.actions)
      .filter(([name]) => stateMachine.getAvailableTools(this.currentState).includes(name))
      .map(([name, action]) => {
        const params = Object.entries(action.params)
          .map(([paramName, param]) => {
            const paramInfo = param as any;
            let paramDesc = `${paramName}ï¼ˆ${paramInfo.type}ï¼‰ï¼š${paramInfo.description}`;
            
            // å¦‚æœæ˜¯é™£åˆ—ä¸”æœ‰ items å®šç¾©ï¼ŒåŠ å…¥é™£åˆ—é …ç›®çš„çµæ§‹èªªæ˜
            if (paramInfo.type === 'array' && paramInfo.items) {
              if (paramInfo.items.type === 'object' && paramInfo.items.properties) {
                const itemProps = Object.entries(paramInfo.items.properties)
                  .map(([propName, prop]) => {
                    const propInfo = prop as any;
                    return `    - ${propName}ï¼ˆ${propInfo.type}ï¼‰ï¼š${propInfo.description}`;
                  })
                  .join('\n');
                paramDesc += `\n  é™£åˆ—é …ç›®çµæ§‹ï¼š\n${itemProps}`;
              } else {
                paramDesc += `\n  é™£åˆ—é …ç›®é¡å‹ï¼š${paramInfo.items.type}`;
              }
            }
            
            return paramDesc;
          })
          .join('\n');
        return `å·¥å…·ï¼š${name}
- åŠŸèƒ½ï¼š${action.description}
- åƒæ•¸ï¼š
${params}`;
      })
      .join('\n\n');
  }

  private getToolUsagePrompt(): string {
    return `
å·¥å…·ä½¿ç”¨èªªæ˜ï¼š
1. ä½ ä¸èƒ½ç›´æ¥åŸ·è¡Œå‹•ä½œï¼Œåªèƒ½ã€Œå»ºè­°æ‡‰è©²åšä»€éº¼å‹•ä½œã€ã€‚
2. ç³»çµ±æœƒæ ¹æ“šä½ çš„å»ºè­°å…§å®¹ï¼Œè«‹ä½¿ç”¨è€…ç¢ºèªæ˜¯å¦åŸ·è¡Œï¼ŒçœŸæ­£çš„åŸ·è¡Œæœƒç”±ç³»çµ±å®Œæˆã€‚
3. è«‹åœ¨å›æ‡‰ä¸­åŠ å…¥é¼“å‹µèˆ‡å¼•å°èªå¥ï¼Œä½†ä¸èƒ½èªªã€Œæˆ‘å·²ç¶“ç‚ºä½ å»ºç«‹äº†...ã€ã€ã€Œæˆ‘å·²ç¶“å®Œæˆ...ã€ï¼Œé€™æ¨£æœƒèª¤å°ä½¿ç”¨è€…ã€‚
4. ä¸èƒ½é¸æ“‡ä¸å­˜åœ¨çš„å·¥å…·ï¼Œè«‹é¸æ“‡å¯ç”¨çš„å·¥å…·ã€‚

ã€å¯ç”¨å·¥å…· - å¿…é ˆåœ¨ä»¥ä¸‹æŒ‘ä¸€å€‹å·¥å…·ä¾†ä½¿ç”¨, è‹¥ç„¡é©åˆçš„å‰‡ä½¿ç”¨ chat å·¥å…·ã€‘
${this.getActionsDescription()}
*** å¿…é ˆä½¿ç”¨ä»¥ä¸Šçš„å·¥å…·ï¼Œå¦å‰‡ç³»çµ±ç„¡æ³•åŸ·è¡Œã€‚ ***

è«‹ä½¿ç”¨ä»¥ä¸‹ JSON æ ¼å¼å›æ‡‰ï¼š
{
  "tool": "action_name",
  "params": {
    "param_name": "param_value"
  },
  "message": "Your response message to the user"
}`;
  }

  constructor() {
    this.model = new ChatOpenAI({
      maxRetries: 3,
      temperature: 0.7,
    });

    // åˆå§‹åŒ–è‡ªå®šç¾©è¨˜æ†¶ç³»çµ±
    this.memory = new CustomSummaryMemory();

    // å»ºç«‹å°è©±éˆ
    this.chain = RunnableSequence.from([
      async (input: string) => {
        const memoryVars = await this.memory.loadMemoryVariables({});
        const prompt = ChatPromptTemplate.fromMessages([
          ['system', await this.buildSystemPrompt()],
          ['system', 'Current Mindmap Context: {mindmapContext}'],
          new MessagesPlaceholder('history'),
          ['human', '{input}']
        ]);
        return {
          input,
          history: memoryVars.history,
          mindmapContext: this.mindmapContext,
          prompt
        };
      },
      async ({ input, history, mindmapContext, prompt }) => {
        return prompt.formatMessages({
          input,
          history,
          mindmapContext
        });
      },
      this.model,
    ]);
  }

  private async buildSystemPrompt(): Promise<string> {
    return buildChatPrompt({
      state: this.currentState,
      level: this.currentLevel,
      tools: this.getActionsDescription()
    });
  }

  // æ›´æ–° mindmap ä¸Šä¸‹æ–‡
  public updateMindmapContext(context: any) {
    this.mindmapContext = context;
  }

  // ç™¼é€è¨Šæ¯ä¸¦ç²å–å›æ‡‰
  public async sendMessage(
    message: string,
    options?: {
      state?: keyof typeof STATE_PROMPTS;
      level?: keyof typeof LEVEL_PROMPTS;
    }
  ): Promise<ChatResponse> {
    try {
      // å¦‚æœæœ‰æä¾›æ–°çš„ state æˆ– levelï¼Œå°±æ›´æ–°
      if (options?.state) this.currentState = options.state;
      if (options?.level) this.currentLevel = options.level;

      // å¾è¨˜æ†¶ä¸­ç²å–æ­·å²
      const memoryVars = await this.memory.loadMemoryVariables({});
      
      // å‘¼å«å¾Œç«¯ API
      const response = await api.post('/api/chat/completions', {
        messages: [
          { role: 'system', content: await this.buildSystemPrompt() },
          { role: 'system', content: JSON.stringify({ type: 'mindmap_context', data: this.mindmapContext }) },
          { role: 'system', content: JSON.stringify({ type: 'state_prompt', data: STATE_PROMPTS[this.currentState] }) },
          { role: 'system', content: JSON.stringify({ type: 'level_prompt', data: LEVEL_PROMPTS[this.currentLevel] }) },
          { role: 'system', content: this.getActionsDescription() ? JSON.stringify({ type: 'tool_usage', data: this.getToolUsagePrompt() }) : '' },
          ...memoryVars.history.map(msg => ({
            role: msg instanceof HumanMessage ? 'user' : 'assistant',
            content: msg.content
          })),
          { role: 'user', content: message }
        ].filter(msg => msg.content),
        temperature: 0.7
      });

      // ä¿å­˜ä¸Šä¸‹æ–‡
      await this.memory.saveContext(
        { input: message },
        { output: response.data.choices[0].message.content }
      );

      return {
        message: response.data.choices[0].message.content,
        role: 'assistant'
      };
    } catch (error) {
      console.error('âŒ Chat error:', error);
      return {
        message: '',
        role: 'assistant',
        error: error instanceof Error ? error.message : 'æœªçŸ¥éŒ¯èª¤',
      };
    }
  }

  // æ¸…é™¤å°è©±æ­·å²
  public clearHistory(): void {
    this.memory.clear();
  }
} 