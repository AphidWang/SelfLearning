# 圖片處理模組測試說明

## 概述

這個測試檔案 (`test-image-processor.test.ts`) 為圖片處理模組提供了完整的測試覆蓋，包括：

- ✅ 檔案驗證功能
- ✅ 工具函數測試
- ✅ 瀏覽器能力檢測
- ✅ 主要處理器功能
- ✅ 整合測試

## 執行測試

### 單獨執行圖片處理測試

```bash
# 在專案根目錄執行
yarn test test-image-processor
```

### 執行所有測試

```bash
yarn test
```

### 監控模式

```bash
yarn test --watch test-image-processor
```

## 測試結構

### 1. 工具函數測試

測試核心工具函數的正確性：

- `validateImageFile()` - 檔案驗證
- `getImageDimensions()` - 圖片尺寸獲取
- `calculateScaledDimensions()` - 縮放計算
- `formatFileSize()` - 檔案大小格式化
- `createFriendlyError()` - 友善錯誤訊息
- 檔案格式檢測函數

### 2. 瀏覽器能力檢測測試

測試 `ImageCapabilities` 類別：

- Canvas 支援檢測
- WebWorker 支援檢測
- 格式支援檢測
- 處理策略推薦

### 3. 主要處理器測試

測試 `ImageProcessor` 的核心功能：

- 標準 JPEG 處理
- 大圖片縮放
- HEIC 格式轉換
- 進度回調處理
- 錯誤處理
- 各種處理方法回退

### 4. 整合測試

測試完整的處理流程和實際使用場景。

## 模擬設定

測試使用了以下模擬 (mocks)：

- **Canvas API** - 模擬瀏覽器 Canvas 功能
- **Image API** - 模擬圖片載入
- **URL API** - 模擬 Blob URL 操作
- **外部庫**：
  - `heic2any` - HEIC 轉換
  - `pica` - 高品質縮放
  - `browser-image-compression` - 圖片壓縮

## 測試覆蓋範圍

### 成功情況
- ✅ 正常檔案處理
- ✅ 格式轉換
- ✅ 尺寸縮放
- ✅ 品質壓縮
- ✅ 進度追蹤

### 錯誤情況
- ✅ 無效檔案格式
- ✅ 檔案過大
- ✅ 瀏覽器不支援
- ✅ 網路錯誤
- ✅ 記憶體不足

### 邊界情況
- ✅ 空檔案
- ✅ 極大圖片
- ✅ 各種格式
- ✅ 回退方案

## 預期結果

所有測試應該通過，並且：

1. **檔案驗證** - 正確識別有效/無效檔案
2. **尺寸計算** - 準確計算縮放比例
3. **錯誤處理** - 提供友善的中文錯誤訊息
4. **處理器** - 選擇最佳處理方法
5. **整合** - 完整處理流程運行順暢

## 故障排除

### 常見問題

1. **導入錯誤**
   ```
   解決方案：確認 tsconfig.json 中的 path mapping 設定正確
   ```

2. **模擬失效**
   ```
   解決方案：檢查 beforeEach 中的模擬設定是否正確
   ```

3. **非同步測試超時**
   ```
   解決方案：增加測試超時時間或檢查 Promise 處理
   ```

### 除錯技巧

1. 使用 `console.log` 在測試中查看變數值
2. 單獨執行失敗的測試案例
3. 檢查模擬函數的調用參數

## 性能測試

雖然這些是單元測試，但也可以觀察：

- 處理時間 (模擬環境下)
- 記憶體使用 (透過檔案大小測試)
- 壓縮比例計算

## 未來改進

- [ ] 增加更多邊界測試案例
- [ ] 添加性能基準測試
- [ ] 測試實際檔案處理 (需要測試資產)
- [ ] 瀏覽器相容性測試 